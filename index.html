<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Funcional Firebase</title>
<style>
body{margin:0;font-family:sans-serif;background:#0e0e11;color:#eee;display:flex;height:100vh}
.sidebar{width:300px;background:#111;padding:20px;display:flex;flex-direction:column;gap:12px;overflow:auto}
.main{flex:1;background:#0d0d0d;padding:20px;display:flex;flex-direction:column}
button{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
.friend, .request{padding:8px;border-radius:8px;background:#222;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;cursor:pointer}
.friend:hover,.request:hover{background:#333}
.msg{padding:6px 10px;border-radius:10px;margin-bottom:6px;max-width:60%}
.msg.me{background:#1f8a42;margin-left:auto;color:#fff}
.msg.their{background:#333;margin-right:auto;color:#fff}
#msg-input{flex:1;padding:8px;border-radius:8px;border:none;background:#222;color:#eee;margin-right:6px}
.composer{display:flex;margin-top:auto;gap:6px}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Usuário: <span id="me-name">Convidado</span></h2>
  <button id="btn-login">Login</button>
  <button id="btn-logout" style="display:none">Logout</button>
  <hr>
  <button id="btn-add-friend">Adicionar amigo</button>
  <h3>Amigos</h3>
  <div id="friends-list"></div>
  <h3>Solicitações</h3>
  <div id="requests-list"></div>
</div>

<div class="main">
  <h2 id="chat-with">Nenhum chat selecionado</h2>
  <div id="chat-messages" style="flex:1;overflow:auto;margin-bottom:12px"></div>
  <div class="composer">
    <input type="text" id="msg-input" placeholder="Digite mensagem..." disabled>
    <button id="send-btn" disabled>Enviar</button>
  </div>
</div>

<!-- login prompt simples -->
<div id="login-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center">
  <div style="background:#222;padding:20px;border-radius:10px;display:flex;flex-direction:column;gap:8px">
    <input id="login-username" placeholder="Seu username" style="padding:8px;border-radius:6px;border:none;background:#111;color:#eee">
    <button id="login-ok">Entrar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBKotEIdaCZbPs3e6cX-0Pnlfa9pqomJ5o",
  authDomain: "chat-36f52.firebaseapp.com",
  projectId: "chat-36f52",
  storageBucket: "chat-36f52.firebasestorage.app",
  messagingSenderId: "613319905986",
  appId: "1:613319905986:web:1a66837932a040e766e15b",
  measurementId: "G-11C0W35NQ7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// elementos
const btnLogin = document.getElementById('btn-login');
const btnLogout = document.getElementById('btn-logout');
const loginModal = document.getElementById('login-modal');
const loginOk = document.getElementById('login-ok');
const loginUsername = document.getElementById('login-username');
const meNameEl = document.getElementById('me-name');

const btnAddFriend = document.getElementById('btn-add-friend');
const friendsListEl = document.getElementById('friends-list');
const requestsListEl = document.getElementById('requests-list');

const chatWithEl = document.getElementById('chat-with');
const chatMessagesEl = document.getElementById('chat-messages');
const msgInput = document.getElementById('msg-input');
const sendBtn = document.getElementById('send-btn');

let currentUser = null;
let activeChatPeer = null;
let chatUnsub = null;

// funções
function normalize(u){return u.trim().toLowerCase()}
function toast(m){alert(m)}

// login
btnLogin.onclick = ()=>{loginModal.style.display='flex'}
loginOk.onclick = async ()=>{
  const uname = normalize(loginUsername.value)
  if(!uname){toast('Digite username'); return;}
  const userRef = db.doc('users/'+uname)
  const snap = await userRef.get()
  if(!snap.exists){
    await userRef.set({friends:[],name:uname})
  }
  currentUser = uname
  meNameEl.textContent = currentUser
  loginModal.style.display='none'
  btnLogin.style.display='none'
  btnLogout.style.display='inline-block'
  watchFriends()
  watchRequests()
}

// logout
btnLogout.onclick = ()=>{
  if(chatUnsub) chatUnsub()
  currentUser = null
  activeChatPeer = null
  meNameEl.textContent='Convidado'
  friendsListEl.innerHTML=''
  requestsListEl.innerHTML=''
  chatMessagesEl.innerHTML=''
  btnLogin.style.display='inline-block'
  btnLogout.style.display='none'
  msgInput.disabled = true
  sendBtn.disabled = true
}

// adicionar amigo
btnAddFriend.onclick = async ()=>{
  if(!currentUser) return toast('Faça login')
  const friend = normalize(prompt('Username do amigo'))
  if(!friend) return
  if(friend===currentUser) return toast('Não pode adicionar você mesmo')
  const fRef = db.doc('users/'+friend)
  const fsnap = await fRef.get()
  if(!fsnap.exists) return toast('Usuário não encontrado')
  await db.collection('friendRequests').add({from:currentUser,to:friend,status:'pending'})
  toast('Solicitação enviada')
}

// watch friends
function watchFriends(){
  if(!currentUser) return
  db.doc('users/'+currentUser).onSnapshot(snap=>{
    friendsListEl.innerHTML=''
    const data = snap.data()
    const friends = data.friends || []
    if(friends.length===0){friendsListEl.innerHTML='<i>Nenhum amigo</i>'; return;}
    friends.forEach(async f=>{
      const fSnap = await db.doc('users/'+f).get()
      const fData = fSnap.exists ? fSnap.data() : {name:f}
      const div = document.createElement('div'); div.className='friend'; div.textContent=fData.name
      div.onclick = ()=>openChat(fData.name)
      friendsListEl.appendChild(div)
    })
  })
}

// watch requests
function watchRequests(){
  if(!currentUser) return
  db.collection('friendRequests').where('to','==',currentUser).where('status','==','pending')
    .onSnapshot(snap=>{
      requestsListEl.innerHTML=''
      if(snap.empty){requestsListEl.innerHTML='<i>Nenhuma solicitação</i>'; return;}
      snap.docs.forEach(async d=>{
        const r = d.data(); const id=d.id
        const div = document.createElement('div'); div.className='request'
        div.innerHTML=`${r.from} <button id="accept">✔</button><button id="decline">✖</button>`
        div.querySelector('#accept').onclick=async ()=>{
          await db.doc('users/'+currentUser).update({friends:firebase.firestore.FieldValue.arrayUnion(r.from)})
          await db.doc('users/'+r.from).update({friends:firebase.firestore.FieldValue.arrayUnion(currentUser)})
          await db.doc('friendRequests/'+id).delete()
        }
        div.querySelector('#decline').onclick=async ()=>{await db.doc('friendRequests/'+id).delete()}
        requestsListEl.appendChild(div)
      })
    })
}

// chat
function openChat(peer){
  if(chatUnsub) chatUnsub()
  activeChatPeer = peer
  chatWithEl.textContent = 'Chat com '+peer
  msgInput.disabled = false; sendBtn.disabled = false
  const chatId = [currentUser,peer].sort().join('__')
  chatUnsub = db.collection('chats').doc(chatId).collection('messages').orderBy('ts').onSnapshot(snap=>{
    chatMessagesEl.innerHTML=''
    snap.docs.forEach(d=>{
      const m = d.data()
      const div = document.createElement('div')
      div.className='msg '+(m.from===currentUser?'me':'their')
      div.textContent = m.from+': '+m.text
      chatMessagesEl.appendChild(div)
    })
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight
  })
}

// send message
sendBtn.onclick=async ()=>{
  const text = msgInput.value.trim()
  if(!text) return
  const chatId = [currentUser,activeChatPeer].sort().join('__')
  await db.collection('chats').doc(chatId).collection('messages').add({
    from:currentUser,to:activeChatPeer,text,ts:firebase.firestore.FieldValue.serverTimestamp()
  })
  msgInput.value=''
}

msgInput.addEventListener('keydown',(e)=>{if(e.key==='Enter') sendBtn.click()})
</script>

</body>
</html>
