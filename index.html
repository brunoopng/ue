<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:#0E0E11;color:#EDEDED;transition:.3s}
body.light{background:#fff;color:#111}

/* Navbar */
nav{position:fixed;top:0;width:100%;height:60px;display:flex;align-items:center;padding:0 16px;z-index:1000;background:#0E0E11;transition:.3s}
body.light nav{background:#fff;color:#111}
nav h1{font-family:'Space Grotesk',sans-serif;font-size:1.5rem;font-weight:700;color:inherit;transition:.3s;cursor:pointer; -webkit-tap-highlight-color: transparent; outline: none;}
nav h1.clicked{transform:scale(0.95); transition: transform 0.1s ease;}

/* Input busca */
nav input{margin-left:16px;flex:1;max-width:220px;padding:6px 12px;border-radius:12px;border:1px solid #555;background:#1C1C1C;color:#EDEDED;transition:.3s}
body.light nav input{background:#f2f2f2;color:#111;border:1px solid #ccc;}
#search:focus{outline:none; box-shadow:none;}

/* Engrenagem tema */
#theme-gear{position:absolute;right:20px;font-size:1.5rem;cursor:pointer;top:50%;transform:translateY(-50%); -webkit-tap-highlight-color: transparent; outline:none;}
#theme-menu{display:none;position:absolute;top:110%;right:0;background:#18181F;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.4);flex-direction:column;}
#theme-menu button{padding:8px 12px;border:none;background:none;color:#fff;cursor:pointer;width:100%;text-align:left;}
#theme-menu button:hover{background:#333;}
body.light #theme-menu{background:#f2f2f2;color:#111;}
body.light #theme-menu button:hover{background:#ddd;color:#111;}

/* Main grid layout */
main{padding-top:80px;padding-bottom:120px;display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}

/* Cards */
.card{position:relative;border-radius:16px;overflow:hidden;background:#18181F;cursor:pointer;transition:.3s;}
.card img{width:100%;display:block;border-radius:16px;object-fit:cover;height:220px;}

/* Fade-in cards */
.fade-in{animation:fadeIn .5s forwards}
@keyframes fadeIn{to{opacity:1;transform:translateY(0)}}

/* Sugestões autocomplete */
.autocomplete-suggestions{position:absolute;background:#18181F;color:#fff;border-radius:12px;top:50px;left:16px;right:16px;max-height:200px;overflow-y:auto;z-index:10000;box-shadow:0 5px 15px rgba(0,0,0,.3)}
body.light .autocomplete-suggestions{background:#f2f2f2;color:#111}
.suggestion{padding:8px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:.2s}
.suggestion img{width:30px;height:30px;border-radius:6px;object-fit:cover}
.suggestion:hover{background:#555;color:#fff}

/* Tela detalhe imagem */
#detail-page{display:none;flex-direction:column;align-items:center;justify-content:flex-start;padding-top:0;background:#0E0E11;color:#EDEDED;min-height:100vh;}
body.light #detail-page{background:#fff;color:#111}
#detail-img{width:100%;max-height:80vh;object-fit:contain;margin-bottom:20px;display:block;margin-left:auto;margin-right:auto;}
#detail-desc{max-width:90%;text-align:center;font-size:1rem;color:#ccc;margin-bottom:12px;}

/* MENU LATERAL */
#side-menu{position:fixed;top:0;right:-320px;width:320px;height:100%;background:#0B0B0C;color:#fff;box-shadow:-2px 0 24px rgba(0,0,0,0.6);z-index:1500;padding:22px;display:flex;flex-direction:column;gap:14px;transition:right 0.28s cubic-bezier(.2,.9,.2,1);overflow-y:auto;border-top-left-radius:14px;border-bottom-left-radius:14px;}
#side-menu .close-menu{align-self:flex-end;font-size:1.6rem;background:none;border:none;color:#fff;cursor:pointer;transition:.2s}
#side-menu .close-menu:hover{color:#999}
#side-menu .profile{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:6px;}
#side-menu .profile img{width:84px;height:84px;border-radius:50%;object-fit:cover;border:2px solid #222;background:#111;padding:2px;}
#side-menu .profile h2{font-size:1.05rem;font-weight:700;color:#eee;margin-top:4px;}
#side-menu .login-btn{padding:10px 16px;border-radius:12px;border:none;background:#222;color:#fff;font-weight:700;cursor:pointer;transition:.18s;width:100%;margin-top:6px;}
#side-menu .login-btn:hover{background:#111}
#side-menu.open{right:0}

/* Friends area (minimal & harmonious) */
.friends-section{margin-top:6px}
.friends-section h4{font-size:.72rem;color:#9a9a9a;letter-spacing:1px;margin-bottom:8px}
#friends-list{display:flex;flex-direction:column;gap:8px}
.friend-card{
  display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));cursor:pointer;
  transition:background .15s;
}
.friend-card:hover{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02))}
.friend-card img{width:38px;height:38px;border-radius:50%;object-fit:cover;border:1px solid #222}
.friend-name{font-size:.95rem;color:#e6e6e6}

/* Requests list */
#requests-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.request-card{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px;border-radius:10px;background:#0F0F10;border:1px solid #151515}
.request-left{display:flex;align-items:center;gap:10px}
.req-actions button{margin-left:6px;padding:6px 8px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.req-accept{background:#1f8a42;color:#fff}
.req-decline{background:transparent;border:1px solid #333;color:#ddd}

/* Profile modal (view profile) */
#friend-profile-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:2000;align-items:center;justify-content:center}
#friend-profile-card{background:#080809;padding:20px;border-radius:14px;width:300px;text-align:center}
#friend-profile-card img{width:90px;height:90px;border-radius:50%;object-fit:cover;border:2px solid #222;margin-bottom:10px}
#friend-profile-card h3{color:#fff;margin-bottom:6px}
#friend-profile-card p{color:#bdbdbd;font-size:.95rem}

/* small helpers */
.small-muted{font-size:.82rem;color:#9a9a9a}
</style>
</head>
<body>

<nav>
<h1>Project</h1>
<input type="text" id="search" placeholder="Buscar jogos...">
<div id="theme-gear">⚙
  <div id="theme-menu">
    <button data-theme="light">Claro</button>
    <button data-theme="dark">Escuro</button>
  </div>
</div>
<div class="autocomplete-suggestions" id="suggestions"></div>
</nav>

<main id="main"></main>

<!-- Tela de detalhe -->
<div id="detail-page">
  <img id="detail-img" src="">
  <p id="detail-desc"></p>
</div>

<!-- Modal login -->
<div id="login-modal">
  <div class="modal-content">
    <h3>Digite seu nome</h3>
    <input type="text" id="login-input" placeholder="Seu nome...">
    <button id="login-save">Salvar</button>
  </div>
</div>

<!-- Friend profile modal -->
<div id="friend-profile-modal">
  <div id="friend-profile-card">
    <img id="fp-avatar" src="https://via.placeholder.com/90" alt="avatar">
    <h3 id="fp-name">Nome</h3>
    <p id="fp-bio" class="small-muted">Bio</p>
    <div style="margin-top:12px">
      <button id="fp-close" style="padding:8px 12px;border-radius:10px;border:none;background:#222;color:#fff;cursor:pointer">Fechar</button>
    </div>
  </div>
</div>

<!-- Menu lateral -->
<div id="side-menu">
  <button class="close-menu">&times;</button>
  <div class="profile">
    <img id="profile-pic" src="https://via.placeholder.com/80" alt="Foto de perfil">
    <h2 id="profile-name">Convidado</h2>
    <div class="small-muted" id="profile-bio-mini" style="margin-top:6px;color:#999;font-size:.82rem">Sem bio</div>
  </div>

  <div class="friends-section" id="friends-section">
    <h4>AMIGOS</h4>
    <div id="friends-list"></div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="open-add-friend" class="login-btn" style="flex:1">Adicionar amigo</button>
      <button id="open-requests" class="login-btn" style="flex:1;background:#151515">Solicitações</button>
    </div>

    <div id="requests-list" style="margin-top:12px;display:none"></div>
  </div>

  <button class="login-btn" id="menu-login-btn">Login</button>
</div>

<script>
const API_KEY='bfd4ae3a6ba14d47a3c627bad684acd8';
const themeGear=document.getElementById('theme-gear');
const themeMenu=document.getElementById('theme-menu');
const searchInput=document.getElementById('search');
const suggestionsDiv=document.getElementById('suggestions');
const main=document.getElementById('main');
const detailPage=document.getElementById('detail-page');
const detailImg=document.getElementById('detail-img');
const sideMenu=document.getElementById('side-menu');
const closeMenuBtn=sideMenu.querySelector('.close-menu');
const profileName=document.getElementById('profile-name');
const profilePic=document.getElementById('profile-pic');
const profileBioMini=document.getElementById('profile-bio-mini');
const loginModal=document.getElementById('login-modal');
const loginInput=document.getElementById('login-input');
const loginSave=document.getElementById('login-save');
const menuLoginBtn=document.getElementById('menu-login-btn');

const friendsListEl=document.getElementById('friends-list');
const openAddFriendBtn=document.getElementById('open-add-friend');
const openRequestsBtn=document.getElementById('open-requests');
const requestsListEl=document.getElementById('requests-list');

const friendProfileModal=document.getElementById('friend-profile-modal');
const fpAvatar=document.getElementById('fp-avatar');
const fpName=document.getElementById('fp-name');
const fpBio=document.getElementById('fp-bio');
const fpClose=document.getElementById('fp-close');

/* ================== Tema engrenagem ================== */
themeGear.addEventListener('click',()=>{
  themeMenu.style.display=themeMenu.style.display==='flex'?'none':'flex';
  themeMenu.style.flexDirection='column';
});
themeMenu.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(btn.dataset.theme==='light') document.body.classList.add('light');
    else document.body.classList.remove('light');
    themeMenu.style.display='none';
  });
});

/* ================== Swipe menu direita -> esquerda mobile ================== */
let startX=0;
let isDragging=false;
document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
document.addEventListener('touchmove', e => {
  const currentX = e.touches[0].clientX;
  if (!sideMenu.classList.contains('open') && startX > 0 && startX - currentX > 50) {
    sideMenu.classList.add('open');
    isDragging = true;
  }
});
document.addEventListener('touchend', () => { isDragging=false; });
closeMenuBtn.addEventListener('click',()=>{sideMenu.classList.remove('open');});

/* ================== Login imersivo minimalista (UI) ================== */
menuLoginBtn.addEventListener('click',()=>{ loginModal.style.display='flex'; });
loginSave.addEventListener('click',()=>{
  const username=loginInput.value.trim();
  if(username){
    profileName.textContent=username;
    profileBioMini.textContent='Carregando...';
    loginModal.style.display='none';
    menuLoginBtn.style.display='none';
    // Firestore actions handled in module script below
    // set currentUser in module via listener bound there
  }
});
loginModal.addEventListener('click',e=>{if(e.target===loginModal) loginModal.style.display='none';});

/* toggle requests view */
openRequestsBtn.addEventListener('click',()=>{
  requestsListEl.style.display = requestsListEl.style.display === 'none' ? 'block' : 'none';
});

/* add friend prompt (UI only; module handles firestore) */
openAddFriendBtn.addEventListener('click', async ()=>{
  const name = prompt('Digite o username exato do amigo:');
  if(!name) return;
  // module script will handle; we dispatch custom event with detail
  window.dispatchEvent(new CustomEvent('app:addFriendRequest',{detail:{to:name}}));
});

/* ================== Render jogos e autocomplete ================== */
let currentImage=null;
let knownGames=[];
function debounce(func,delay){let timer; return function(...args){clearTimeout(timer);timer=setTimeout(()=>func.apply(this,args),delay);}}

async function fetchGames(query){
  const res=await fetch(`https://api.rawg.io/api/games?key=${API_KEY}&search=${encodeURIComponent(query)}&page_size=10`);
  const data=await res.json();
  return data.results||[];
}

searchInput.addEventListener('input',debounce(async ()=>{
  suggestionsDiv.innerHTML='';
  const val=searchInput.value.trim();
  if(!val) return;
  const games=await fetchGames(val);
  games.forEach(g=>{
    const div=document.createElement('div');
    div.className='suggestion';
    const img=document.createElement('img');
    img.src=g.background_image||'https://via.placeholder.com/30';
    const span=document.createElement('span');
    span.textContent=g.name;
    div.appendChild(img); div.appendChild(span);
    div.addEventListener('click',()=>{
      searchInput.value=g.name;
      suggestionsDiv.innerHTML='';
      renderGames([{
        name:g.name,
        desc:g.released||'',
        img:g.background_image||'https://via.placeholder.com/250'
      }]);
    });
    suggestionsDiv.appendChild(div);
  });
},300));

function renderGames(custom=[]){
  main.innerHTML='';
  let games=custom.length?custom:JSON.parse(localStorage.getItem('games'))||[];
  const query=searchInput.value.toLowerCase().trim();
  if(query) games=games.filter(g=>g.name.toLowerCase().includes(query));
  games.forEach(g=>{
    const card=document.createElement('div'); card.className='card';
    const img=document.createElement('img'); img.src=g.img||'https://via.placeholder.com/250';
    card.appendChild(img);
    card.onclick=()=>{
      detailPage.style.display='flex';
      main.style.display='none';
      detailImg.src=g.img;
      detailImg.style.width='100%';
      detailImg.style.maxHeight='80vh';
      detailImg.style.objectFit='contain';
      detailImg.style.display='block';
      detailImg.style.margin='0 auto';
    };
    main.appendChild(card);
    card.classList.add('fade-in');
  });
}

/* ================== Voltar ao clicar em Project ================== */
document.querySelector('nav h1').addEventListener('click',()=>{
  const projectTitle=document.querySelector('nav h1');
  projectTitle.classList.add('clicked');
  setTimeout(()=>projectTitle.classList.remove('clicked'),150);
  detailPage.style.display='none';
  main.style.display='grid';
  searchInput.value='';
  renderGames([]);
});

renderGames();

/* friend profile modal close */
fpClose.addEventListener('click',()=>friendProfileModal.style.display='none');
friendProfileModal.addEventListener('click',(e)=>{ if(e.target===friendProfileModal) friendProfileModal.style.display='none' });
</script>

<!-- FIREBASE MODULE: friends, requests, real-time -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove,
  collection, addDoc, query, where, getDocs, onSnapshot, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

/* Use your Firebase config (you sent earlier) */
const firebaseConfig = {
  apiKey: "AIzaSyCDsIWhMHMRePqWHPVgaTWaEIVfWNVeMQo",
  authDomain: "project-6787c.firebaseapp.com",
  projectId: "project-6787c",
  storageBucket: "project-6787c.firebasestorage.app",
  messagingSenderId: "603584412230",
  appId: "1:603584412230:web:46d41b1081a99aed8a2847",
  measurementId: "G-PW0743QWMJ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = null; // username string

// Elements
const profileNameEl = document.getElementById('profile-name');
const profilePicEl = document.getElementById('profile-pic');
const profileBioMini = document.getElementById('profile-bio-mini');
const menuLoginBtn = document.getElementById('menu-login-btn');

const friendsListEl = document.getElementById('friends-list');
const requestsListEl = document.getElementById('requests-list');

const friendProfileModal = document.getElementById('friend-profile-modal');
const fpAvatar = document.getElementById('fp-avatar');
const fpNameEl = document.getElementById('fp-name');
const fpBioEl = document.getElementById('fp-bio');

// helper: show friend profile in modal
function showFriendProfile(data){
  fpAvatar.src = data.avatar || 'https://via.placeholder.com/90';
  fpNameEl.textContent = data.name || '—';
  fpBioEl.textContent = data.bio || 'Sem bio';
  friendProfileModal.style.display = 'flex';
}

// get user doc snapshot
async function getUserDoc(username){
  if(!username) return null;
  const ref = doc(db, 'users', username);
  const snap = await getDoc(ref);
  return snap.exists() ? snap : null;
}

// create user doc when login pressed
// Listen for the loginSave click event (UI script sets UI and triggers this)
const loginSaveBtn = document.getElementById('login-save');
loginSaveBtn.addEventListener('click', async ()=> {
  const username = document.getElementById('login-input').value.trim();
  if(!username) return;
  currentUser = username;
  // create or ensure doc exists
  const userRef = doc(db, 'users', username);
  await setDoc(userRef, {
    name: username,
    bio: '',
    avatar: 'https://via.placeholder.com/90',
    friends: []
  }, { merge: true });
  // update UI
  profileNameEl.textContent = username;
  profileBioMini.textContent = 'Sem bio';
  menuLoginBtn.style.display = 'none';
  // start watchers
  attachRealtimeListeners();
  // initial load
  loadFriends();
  loadIncomingRequests();
});

// attach realtime listener for this user's doc (bio/avatar changes)
let userUnsub = null;
function attachRealtimeListeners(){
  if(!currentUser) return;
  const uref = doc(db, 'users', currentUser);
  if(userUnsub) userUnsub(); // remove old
  userUnsub = onSnapshot(uref, (snap)=>{
    if(!snap.exists()) return;
    const data = snap.data();
    profileNameEl.textContent = data.name || currentUser;
    if(data.avatar) profilePicEl.src = data.avatar;
    profileBioMini.textContent = data.bio || 'Sem bio';
    // refresh lists
    renderFriends(data.friends || []);
  });
  // realtime requests watcher handled separately
  watchIncomingRequestsRealtime();
}

/* FRIENDS: load & render */
async function loadFriends(){
  if(!currentUser) return;
  const uref = doc(db, 'users', currentUser);
  const snap = await getDoc(uref);
  if(!snap.exists()) return;
  const data = snap.data();
  renderFriends(data.friends || []);
}

function clearChildren(el){while(el.firstChild) el.removeChild(el.firstChild);}

function renderFriends(friends){
  clearChildren(friendsListEl);
  if(!friends || friends.length===0){
    const none = document.createElement('div'); none.className='small-muted'; none.textContent='Nenhum amigo ainda';
    friendsListEl.appendChild(none);
    return;
  }
  friends.forEach(async (fname)=>{
    const fsnap = await getUserDoc(fname);
    if(!fsnap) return;
    const f = fsnap.data();
    const card = document.createElement('div');
    card.className = 'friend-card';
    card.innerHTML = `<img src="${f.avatar||'https://via.placeholder.com/90'}"><div class="friend-name">${f.name}</div>`;
    card.addEventListener('click', ()=> showFriendProfile(f));
    friendsListEl.appendChild(card);
  });
}

/* REQUESTS: send, load, accept, decline */

// send request -> create doc in 'friendRequests' collection if not exists
window.addEventListener('app:addFriendRequest', async (e)=>{
  const to = e.detail?.to;
  if(!to) return alert('Nome inválido');
  if(!currentUser) return alert('Faça login antes de enviar pedidos');
  if(to === currentUser) return alert('Você não pode adicionar você mesmo.');
  // check recipient exists
  const treq = await getUserDoc(to);
  if(!treq) return alert('Usuário não encontrado.');
  // check if already friends
  const meSnap = await getUserDoc(curren
