<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Project — Chat</title>
<style>
:root{
  --bg: #0b0b0b;
  --card: #0f1012;
  --muted: #9b9b9b;
  --white: #ffffff;
  --accent: #ffffff;
  --radius: 12px;
  --header-h: 64px;
  --glass: rgba(255,255,255,0.04);
  --fade-duration: 360ms;
  --brand-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  --header-gradient-top: linear-gradient(180deg,var(--card),#090909);
  --bubble-me-bg: #0d0d0d;
  --bubble-their-bg: #ffffff;
  --bubble-me-text: #ffffff;
  --bubble-their-text: #000000;
  --btn-bg: #ffffff;
  --btn-text: #000000;
  --input-bg: #080808;
  --input-text: #ffffff;
}

/* Basic resets */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:var(--brand-font);color:var(--white);-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}
button{font-family:inherit}

/* App layout */
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
header{height:var(--header-h);display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:var(--header-gradient-top);border-bottom:1px solid rgba(255,255,255,0.03);z-index:40}
.brand{display:flex;align-items:center;gap:12px}
.brand svg{width:28px;height:28px}
.brand .title{font-weight:700;letter-spacing:0.6px;font-size:16px}
.top-actions{display:flex;gap:10px;align-items:center}

/* icon button consistent & symmetric */
.icon-btn{
  width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;background:transparent;color:var(--white);border-radius:10px;border:1px solid var(--glass);cursor:pointer;padding:6px;-webkit-tap-highlight-color: transparent;user-select:none}
.icon-btn svg{display:block}
.icon-btn:hover{ background: rgba(255,255,255,0.03); transform: translateY(-2px); transition: transform .12s;}

/* header "Add friend" button */
.btn-header{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;background:var(--btn-bg);color:var(--btn-text);border:none;font-weight:700;font-size:13px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
.btn-header svg{opacity:0.9}
.btn-header:active{transform:translateY(1px)}

/* layout */
.layout{display:flex;flex:1;min-height:0;transition:all var(--fade-duration) cubic-bezier(.2,.9,.2,1)}
/* left panel fixed overlay so center occupies full width when left closed */
.left{width:36%;max-width:420px;min-width:260px;background:var(--card);padding:16px;box-sizing:border-box;border-right:1px solid rgba(255,255,255,0.03);transform:translateX(-110%);opacity:0;pointer-events:none;position:fixed;left:0;top:var(--header-h);bottom:0;z-index:1000;transition:transform .28s ease,opacity .28s ease}
.layout.friends-open .left{transform:translateX(0) !important;opacity:1 !important;pointer-events:auto !important}
.left .panel-top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px}

/* profile block */
.profile-section{display:flex;flex-direction:column;gap:8px;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.profile-row{display:flex;align-items:center;gap:12px;min-width:0}
.profile-row img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.03);flex:0 0 48px}
.profile-name{font-weight:700;color:var(--white);flex:1;min-width:0;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.profile-bio{font-size:0.85rem;color:var(--muted);max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* friends list */
.section-title{font-size:.86rem;color:var(--muted);margin-top:4px;margin-bottom:6px}
.friends-list{overflow:auto;flex:1;padding-right:6px;display:block;min-height:80px}
.friend{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;transition:background .12s,transform .08s}
.friend img{width:44px;height:44px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.03);flex:0 0 44px}
.friend .meta{display:flex;flex-direction:column;min-width:0}
.friend .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
.friend .small{font-size:0.85rem;color:var(--muted);display:inline-block}
.status-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:8px;border:2px solid rgba(11,11,11,1)}
.status-online{background:var(--accent); box-shadow:0 0 6px rgba(31,138,66,0.14)}
.status-offline{background:#666; box-shadow:none}

/* center chat */
.center{flex:1;display:flex;flex-direction:column;padding:12px 12px 140px 12px;box-sizing:border-box;min-width:0;transition:margin var(--fade-duration) cubic-bezier(.2,.9,.2,1)}
.layout.friends-open .center{margin-left:0}
.chat-header{display:flex;align-items:center;gap:12px;padding-bottom:8px}
.peer-avatar{width:48px;height:48px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.03);display:inline-block;flex:0 0 48px;cursor:pointer}
.peer-name{font-weight:700; cursor:pointer}
.peer-sub{font-size:0.9rem;color:var(--muted);display:flex;align-items:center;gap:8px}

/* messages */
.messages{flex:1;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px;width:100%;scroll-behavior:smooth}
.msg-row{display:flex;align-items:flex-end;gap:8px;width:100%;position:relative}
.msg{max-width: calc(100% - 72px);padding:10px 14px;border-radius:14px;word-break:break-word;box-shadow:0 8px 24px rgba(0,0,0,0.45);display:flex;flex-direction:column;text-align:left;align-items:flex-start;flex: 0 1 auto;position:relative}
.msg.me{background:var(--bubble-me-bg);color:var(--bubble-me-text);border:1px solid rgba(255,255,255,0.03)}
.msg.their{background:var(--bubble-their-bg);color:var(--bubble-their-text);border:1px solid rgba(0,0,0,0.04)}
.msg .meta{display:block;font-size:0.78rem;margin-bottom:6px;font-weight:700;line-height:1;text-align:left;width:100%}
.msg-avatar{width:36px;height:36px;border-radius:10px;object-fit:cover;border:1px solid rgba(255,255,255,0.03);flex:0 0 36px;align-self:flex-end;cursor:pointer}
.msg-image{max-width:100%;height:auto;border-radius:10px;display:block;margin-top:8px;cursor:pointer;object-fit:cover}

/* composer */
.composer{position:fixed;right:12px;left:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;padding:10px;background:var(--card);border-radius:14px;border-top:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:30}
.composer-row{display:flex;gap:8px;align-items:center;width:100%}
.composer input[type="text"]{flex:1;padding:12px 14px;border-radius:10px;background:var(--input-bg);border:1px solid rgba(255,255,255,0.03);color:var(--input-text);outline:none}
.btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer}
.btn:active{transform:scale(.98)}
.btn-send{background:var(--btn-bg);color:var(--btn-text);font-weight:700}
.btn-plain{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}

/* reply preview */
.reply-preview{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
.reply-preview .small{font-size:12px;color:var(--muted)}
.reply-preview .text{font-size:13px;max-width:320px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* action popup */
.msg-action-popup{position:fixed;z-index:22000;background:#0f1012;border:1px solid rgba(255,255,255,0.05);padding:8px;border-radius:10px;box-shadow:0 18px 40px rgba(0,0,0,0.6);display:flex;gap:8px;align-items:center}
.msg-action-popup button{background:transparent;color:var(--white);border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.msg-action-popup button:hover{background:rgba(255,255,255,0.02)}

/* modal base */
.modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:20000 !important}
.modal-card{width:360px;background:#0f1012;padding:16px;border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
.modal-card h3{margin:0 0 8px 0}

/* peer profile (detailed) */
.peer-profile-card{width:420px;max-width:92%;background:linear-gradient(180deg,var(--card),#0b0b0b);padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;align-items:flex-start}
.peer-profile-avatar{width:120px;height:120px;border-radius:14px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
.peer-profile-main{flex:1;min-width:0}
.peer-profile-main h2{margin:0 0 6px 0;font-size:20px}
.peer-profile-main .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
.peer-profile-main .bio{margin-top:8px;color:var(--muted);font-size:14px;line-height:1.4}

/* theme swatches */
.theme-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.theme-swatch{width:52px;height:52px;border-radius:8px;cursor:pointer;border:2px solid rgba(255,255,255,0.06);box-shadow:0 8px 30px rgba(0,0,0,0.5)}

/* splash */
#splashScreen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .45s}
#splashScreen.hidden{opacity:0;pointer-events:none}
.splash-inner{display:flex;flex-direction:column;align-items:center;gap:10px;transform-origin:center center;animation: splashIn .8s cubic-bezier(.2,.9,.2,1) both}
@keyframes splashIn {0%{ transform: translateY(8px) scale(.98); opacity:0 }60%{ transform: translateY(-4px) scale(1.02); opacity:1 }100%{ transform: translateY(0) scale(1); opacity:1 }}
.splash-logo{font-weight:800;font-size:34px;letter-spacing:4px}
.splash-sub{font-size:12px;color:rgba(255,255,255,0.6);margin-top:4px}

/* responsive tweaks */
@media (max-width:900px){
  header{padding:0 12px}
  .left{position:fixed;left:0;top:var(--header-h);bottom:0;transform:translateX(-6%);width:86%;max-width:none;min-width:0;padding:12px;border-radius:0 8px 8px 0;box-shadow:0 20px 60px rgba(0,0,0,0.7)}
  .layout.friends-open .left{transform:translateX(0) !important}
  .layout.friends-open .center{margin-left:0}
  .center{padding:8px 8px 140px 8px}
  .msg{max-width:85%}
  .composer{position:fixed;left:0;right:0;bottom:0;border-radius:0;padding:10px 12px;height:auto;display:flex;flex-direction:column;align-items:center;gap:8px}
  .composer-row{width:100%}
}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splashScreen" aria-hidden="false">
  <div class="splash-inner" role="img" aria-label="Project splash">
    <div class="splash-logo" style="color:var(--white)">Project</div>
    <div class="splash-sub">paciência</div>
  </div>
</div>

<div class="app" aria-hidden="false">
  <header>
    <div class="brand" aria-hidden="true">
      <!-- restore original app icon -->
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><rect x="2" y="2" width="20" height="20" rx="5" stroke="white" stroke-opacity="0.06" stroke-width="1.6"/><path d="M7.5 12h9" stroke="white" stroke-width="1.6" stroke-linecap="round"/></svg>
      <div class="title">Project</div>
    </div>

    <div class="top-actions" role="toolbar" aria-label="Ações">
      <button id="btnOpenFriends" type="button" class="icon-btn" aria-label="Amigos" title="Amigos" >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 12a3 3 0 1 0-3-3 3 3 0 0 0 3 3z"/><path d="M4 20v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/></svg>
      </button>

      <button id="btnAddFriend" type="button" class="btn-header" title="Adicionar amigo" aria-label="Adicionar amigo">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#050505" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5v14M5 11h14"/></svg>
        <span style="color:var(--btn-text)">Adicionar</span>
      </button>

      <div class="requests-badge" title="Pedidos">
        <button id="btnRequests" type="button" class="icon-btn" title="Pedidos" aria-label="Pedidos">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        </button>
        <span id="requestsCount" class="count" style="display:none">0</span>
      </div>

      <!-- Header: agora mostra a ENGRENAGEM (Tema) -->
      <button id="btnTheme" type="button" class="icon-btn" title="Tema" aria-label="Abrir tema">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 2.27 17.3l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.6 0 1.1-.42 1.51-1A1.65 1.65 0 0 0 4.33 7.4l-.06-.06A2 2 0 1 1 6.6 2.27l.06.06c.5.5 1.2.6 1.82.33.44-.2 1-.32 1.51-.32H12a2 2 0 1 1 0 4h-.09c-.6 0-1.1.42-1.51 1a1.65 1.65 0 0 0 .33 1.82l.06.06c.5.5.6 1.2.33 1.82.2.44.32 1 .32 1.51V12a2 2 0 1 1 4 0v.09c0 .6.42 1.1 1 1.51z"></path>
        </svg>
      </button>

      <!-- Login button (shows when not logged) -->
      <button id="btnLogin" class="btn btn-send" type="button" style="display:none">Entrar</button>

      <!-- Logout -->
      <button id="btnLogout" type="button" class="icon-btn" title="Sair" aria-label="Sair" style="display:none">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>
      </button>
    </div>
  </header>

  <div class="layout" id="layoutRoot">
    <aside class="left" id="leftPanel" aria-hidden="true">
      <div class="panel-top">
        <div class="title">Seu perfil</div>
        <div class="controls" style="display:flex;gap:8px;align-items:center">
          <!-- O botão ao lado do X agora é CLARAMENTE "Editar perfil" (ícone e title/aria-label) -->
          <button id="btnEditInlineIcon" class="icon-btn" title="Editar perfil" aria-label="Editar perfil">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 20h9" />
              <path d="M16.5 3.5a2.121 2.121 0 113 3L8 18l-4 1 1-4L16.5 3.5z"></path>
            </svg>
          </button>

          <button id="closeFriends" class="icon-btn" title="Fechar lista" aria-label="Fechar lista">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
      </div>

      <div class="profile-section" role="region" aria-label="Seu perfil">
        <div class="profile-row">
          <img id="meAvatarLeft" src="https://via.placeholder.com/48" alt="me" data-user="">
          <div style="display:flex;flex-direction:column;min-width:0">
            <div style="display:flex;align-items:center;gap:8px">
              <div class="profile-name" id="meNameLeft">Convidado</div>
            </div>
            <div class="profile-bio" id="meBioLeft">Editar perfil</div>
          </div>
        </div>
      </div>

      <div class="sep" aria-hidden="true"></div>

      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="section-title">Lista de amigos</div>
      </div>

      <div class="friends-list" id="friendsList" aria-live="polite"></div>
    </aside>

    <main class="center no-active" id="centerMain">
      <div class="chat-header">
        <img id="peerAvatarTop" class="peer-avatar" src="https://via.placeholder.com/48" style="display:none" alt="peer" data-user="">
        <div class="peer-info">
          <div style="display:flex;align-items:center;gap:8px">
            <div class="peer-name" id="peerName">Nenhum chat selecionado</div>
            <span id="peerDotInline" class="status-dot status-offline" title="status-inline" style="display:none"></span>
          </div>
          <div class="peer-status-row" aria-hidden="false">
            <div class="peer-sub" id="peerSub"></div>
          </div>
        </div>
      </div>

      <div class="empty-placeholder" id="emptyPlaceholder">Selecione um amigo para começar</div>

      <div class="messages" id="messages" role="log" aria-live="polite"></div>

      <div class="composer" id="composer" aria-label="Composer de mensagens">
        <div id="replyPreview" style="display:none" class="reply-preview"></div>
        <div class="composer-row">
          <input id="inputText" type="text" placeholder="Digite mensagem..." autocomplete="off" disabled>
          <button id="btnAttach" type="button" class="btn btn-plain" title="Anexar imagem">Mídia</button>
          <input id="inputFile" type="file" accept="image/*" style="display:none">
          <button id="btnSend" type="button" class="btn btn-send" disabled>Enviar</button>
        </div>
        <div id="composerImagePreview" style="display:none"></div>
      </div>
    </main>
  </div>
</div>

<!-- Requests modal -->
<div id="requestsModal" class="modal-backdrop">
  <div id="requestsCard" class="modal-card">
    <h3>Pedidos de amizade</h3>
    <div id="requestsList"></div>
    <div style="text-align:right;margin-top:12px">
      <button type="button" onclick="document.getElementById('requestsModal').style.display='none'" class="btn btn-plain">Fechar</button>
    </div>
  </div>
</div>

<!-- Edit profile modal (compact) -->
<div id="profileModal" class="modal-backdrop">
  <div id="profileCard" class="modal-card" style="display:flex;gap:12px;align-items:center">
    <img id="profileAvatar" src="https://via.placeholder.com/84" alt="avatar" style="width:72px;height:72px;border-radius:12px;object-fit:cover">
    <div style="flex:1">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="profileName" placeholder="Nome (opcional)" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--white)">
        <button id="btnChangeAvatar" type="button" class="btn btn-plain">Alterar</button>
        <input id="profileFile" type="file" accept="image/*" style="display:none">
      </div>
      <textarea id="profileBio" placeholder="Bio (máx 200 chars)" style="width:100%;height:80px;margin-top:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--white);padding:8px"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="btnSaveProfile" type="button" class="btn btn-send">Salvar</button>
        <button id="btnCloseProfile" type="button" class="btn btn-plain">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Peer profile modal (detailed) -->
<div id="peerProfileModal" class="modal-backdrop" aria-hidden="true">
  <div class="peer-profile-card" role="dialog" aria-modal="true" id="peerProfileCard">
    <img id="peerProfileAvatar" class="peer-profile-avatar" src="https://via.placeholder.com/120" alt="avatar">
    <div class="peer-profile-main">
      <h2 id="peerProfileName">Nome</h2>
      <div class="meta" id="peerProfileMeta">offline • visto por último: —</div>
      <div class="bio" id="peerProfileBio">Bio do usuário...</div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="peerProfileClose" class="btn btn-plain" type="button">Fechar</button>
        <button id="peerProfileMessage" class="btn btn-send" type="button">Abrir chat</button>
        <button id="peerProfileAdd" class="btn btn-header" type="button" style="display:none">Adicionar</button>
      </div>
    </div>
  </div>
</div>

<!-- Theme modal -->
<div id="themeModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card" style="width:auto;min-width:300px">
    <h3>Escolha um tema</h3>
    <div style="font-size:13px;color:var(--muted)">O tema altera cor de destaque, fundos, cards e botões para imersão.</div>
    <div class="theme-grid" id="themeGrid"></div>
    <div style="text-align:right;margin-top:12px">
      <button id="themeClose" class="btn btn-plain" type="button">Fechar</button>
    </div>
  </div>
</div>

<!-- LOGIN modal with username + password (hidden until user clicks Entrar) -->
<div id="login-modal" class="modal-backdrop" aria-modal="true" role="dialog" style="display:none" aria-hidden="true">
  <div id="login-card" class="modal-card">
    <h3>Entrar</h3>
    <input id="login-username" placeholder="Seu username" autocomplete="username" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--white)">
    <input id="login-password" type="password" placeholder="Senha" autocomplete="current-password" style="width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--white);margin-top:8px">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="login-ok" class="btn btn-send" style="flex:1">Entrar</button>
      <button id="create-account" class="btn btn-plain" style="flex:1">Criar conta</button>
    </div>
    <div style="margin-top:10px;font-size:12px;color:var(--muted)">Usuário e senha (hash SHA-256) salvos no Firestore.</div>
  </div>
</div>

<!-- action popup -->
<div id="msgActionPopup" style="display:none" class="msg-action-popup" role="dialog" aria-hidden="true"></div>

<!-- Firebase & Supabase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =========================
   Config clients (preserve your keys)
   ========================= */
const SUPABASE_URL = "https://psefyuszpacdfhjrqvwd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzZWZ5dXN6cGFjZGZoanJxdndkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MjgwMjQsImV4cCI6MjA4MzMwNDAyNH0.E2qZxPEim9bW4P4jsHkybsbUYdInGIV19ZMXOHdQXCg";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

firebase.initializeApp({
  apiKey: "AIzaSyBKotEIdaCZbPs3e6cX-0Pnlfa9pqomJ5o",
  authDomain: "chat-36f52.firebaseapp.com",
  projectId: "chat-36f52",
  storageBucket: "chat-36f52.appspot.com"
});
const db = firebase.firestore();
const storage = firebase.storage();
</script>

<script>
/* =========================
   DOM refs
   ========================= */
const splashScreen = document.getElementById('splashScreen');

const layoutRoot = document.getElementById('layoutRoot');
const btnOpenFriends = document.getElementById('btnOpenFriends');
const closeFriends = document.getElementById('closeFriends');
const friendsList = document.getElementById('friendsList');

const meAvatarLeft = document.getElementById('meAvatarLeft');
const meNameLeft = document.getElementById('meNameLeft');
const meBioLeft = document.getElementById('meBioLeft');

const btnEditInlineIcon = document.getElementById('btnEditInlineIcon');
const profileModal = document.getElementById('profileModal');
const btnChangeAvatar = document.getElementById('btnChangeAvatar');
const profileFile = document.getElementById('profileFile');
const profileAvatar = document.getElementById('profileAvatar');
const profileName = document.getElementById('profileName');
const profileBio = document.getElementById('profileBio');
const btnSaveProfile = document.getElementById('btnSaveProfile');
const btnCloseProfile = document.getElementById('btnCloseProfile');

const peerAvatarTop = document.getElementById('peerAvatarTop');
const peerName = document.getElementById('peerName');
const peerDotInline = document.getElementById('peerDotInline');
const peerSub = document.getElementById('peerSub');
const messagesEl = document.getElementById('messages');

const centerMain = document.getElementById('centerMain');
const emptyPlaceholder = document.getElementById('emptyPlaceholder');

const inputText = document.getElementById('inputText');
const btnAttach = document.getElementById('btnAttach');
const inputFile = document.getElementById('inputFile');
const btnSend = document.getElementById('btnSend');
const composerPreviewImg = document.getElementById('composerImagePreview');

const replyPreview = document.getElementById('replyPreview');

const msgActionPopup = document.getElementById('msgActionPopup');

const btnAddFriend = document.getElementById('btnAddFriend');
const btnRequests = document.getElementById('btnRequests');
const requestsCount = document.getElementById('requestsCount');
const requestsModal = document.getElementById('requestsModal');
const requestsList = document.getElementById('requestsList');

const peerProfileModal = document.getElementById('peerProfileModal');
const peerProfileAvatar = document.getElementById('peerProfileAvatar');
const peerProfileName = document.getElementById('peerProfileName');
const peerProfileMeta = document.getElementById('peerProfileMeta');
const peerProfileBio = document.getElementById('peerProfileBio');
const peerProfileClose = document.getElementById('peerProfileClose');
const peerProfileMessage = document.getElementById('peerProfileMessage');
const peerProfileAdd = document.getElementById('peerProfileAdd');

const btnTheme = document.getElementById('btnTheme');
const themeModal = document.getElementById('themeModal');
const themeGrid = document.getElementById('themeGrid');
const themeClose = document.getElementById('themeClose');

const btnLogout = document.getElementById('btnLogout');
const btnLogin = document.getElementById('btnLogin');

const loginModal = document.getElementById('login-modal');
const loginUsername = document.getElementById('login-username');
const loginPassword = document.getElementById('login-password');
const loginOk = document.getElementById('login-ok');
const createAccountBtn = document.getElementById('create-account');

let currentUser = null;
let profileCache = {};
let activePeer = null;
let unsubChat = null;
let unsubPeer = null;
let pendingFileLocal = null;
let friendUnsubs = {};
let audioCtx = null;

/* helpers */
function normalize(u){ return (u||'').toString().trim().toLowerCase(); }
function toast(m){ try{ console.log('TOAST:',m); }catch(e){} alert(m); }
function dbg(...a){ console.log('[DBG]', ...a); }

/* SHA-256 helper (for password hashing) */
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ========== audio: send (grave) and receive (agudo) ========== */
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playSendSound(){
  try{
    const audio = ensureAudio();
    const t = audio.currentTime;
    const o = audio.createOscillator();
    const g = audio.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(900, t);
    o.frequency.exponentialRampToValueAtTime(600, t + 0.12);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.35, t + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.22);
    o.connect(g); g.connect(audio.destination);
    o.start(t);
    o.stop(t + 0.25);
  }catch(e){ console.warn('audio failed', e); }
}
function playReceiveSound(){
  try{
    const audio = ensureAudio();
    const t = audio.currentTime;
    const o = audio.createOscillator();
    const g = audio.createGain();
    o.type = 'sine';
    // higher pitch and shorter duration for received messages
    o.frequency.setValueAtTime(1600, t);
    o.frequency.exponentialRampToValueAtTime(2200, t + 0.06);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.28, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);
    o.connect(g); g.connect(audio.destination);
    o.start(t);
    o.stop(t + 0.12);
  }catch(e){ console.warn('receive audio failed', e); }
}
window.playSendSound = playSendSound;
window.playReceiveSound = playReceiveSound;

/* splash -> show login (or show Entrar in header if not remembered) */
function hideSplashAndShowLogin(){
  splashScreen.classList.add('hidden');
  setTimeout(()=> {
    try{ splashScreen.remove(); }catch(e){}
    const remembered = localStorage.getItem('project_user');
    if(remembered){
      restoreSession(remembered);
    } else {
      try{ loginModal.style.display = 'none'; }catch(e){}
      try{ btnLogin.style.display = 'inline-flex'; }catch(e){}
    }
  }, 700);
}
window.addEventListener('load', ()=> setTimeout(hideSplashAndShowLogin, 900));

/* presence helper */
async function setOnlineState(on){
  if(!currentUser) return;
  try{
    await db.doc('users/'+currentUser).update({ online: !!on, lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
  }catch(e){
    if(on){
      await db.doc('users/'+currentUser).set({ name: currentUser, bio:'', avatar:'', friends:[], online:true, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    }
  }
}
window.addEventListener('beforeunload', ()=> { if(currentUser) db.doc('users/'+currentUser).update({ online:false, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(()=>{}); });

/* ========== AUTH with password (create + login) + persistent session ========== */
createAccountBtn.addEventListener('click', async ()=>{
  const raw = (loginUsername.value||'').trim();
  const pw = (loginPassword.value||'').trim();
  if(!raw || !pw) return toast('Preencha usuário e senha (mín 6 caracteres)');
  if(pw.length < 6) return toast('Senha mínima de 6 caracteres');
  const id = normalize(raw);
  try{
    const ref = db.doc('users/'+id);
    const snap = await ref.get();
    if(snap.exists) return toast('Usuário já existe');
    const hash = await sha256Hex(pw);
    await ref.set({ name: raw, passwordHash: hash, bio:'', avatar:'', friends:[], online:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    toast('Conta criada. Agora faça login.');
  }catch(e){ console.error('create account err', e); toast('Erro ao criar conta'); }
});

loginOk.addEventListener('click', async ()=>{
  const raw = (loginUsername.value||'').trim();
  const pw = (loginPassword.value||'').trim();
  if(!raw || !pw) return toast('Preencha usuário e senha');
  const id = normalize(raw);
  try{
    const ref = db.doc('users/'+id);
    const snap = await ref.get();
    if(!snap.exists) return toast('Usuário não encontrado');
    const data = snap.data() || {};
    const stored = data.passwordHash || '';
    const hash = await sha256Hex(pw);
    if(stored !== hash) return toast('Senha inválida');
    currentUser = id;
    try{ localStorage.setItem('project_user', currentUser); }catch(e){}
    profileCache[currentUser] = { name: data.name || raw, avatar: data.avatar || '', bio: data.bio || '', online: data.online || false, lastSeen: data.lastSeen || null };
    meNameLeft.textContent = profileCache[currentUser].name || currentUser;
    meBioLeft.textContent = profileCache[currentUser].bio || '';
    meAvatarLeft.src = profileCache[currentUser].avatar || 'https://via.placeholder.com/48';
    meAvatarLeft.dataset.user = currentUser;
    try{ loginModal.remove(); }catch(e){ loginModal.style.display='none'; }
    centerMain.classList.add('no-active');
    inputText.value = '';
    btnSend.disabled = true;
    inputText.disabled = true;
    try{ btnLogin.style.display = 'none'; }catch(e){}
    btnLogout.style.display = 'inline-flex';
    await setOnlineState(true);
    watchFriends();
    watchRequests();
  }catch(e){ console.error('login err', e); toast('Erro ao logar'); }
});

/* Restore session if username is in localStorage (no password) */
async function restoreSession(username){
  try{
    const id = normalize(username);
    const ref = db.doc('users/'+id);
    const snap = await ref.get();
    if(!snap.exists){
      localStorage.removeItem('project_user');
      try{ loginModal.style.display = 'none'; }catch(e){}
      try{ btnLogin.style.display = 'inline-flex'; }catch(e){}
      return;
    }
    currentUser = id;
    const data = snap.data() || {};
    profileCache[currentUser] = { name: data.name || id, avatar: data.avatar || '', bio: data.bio || '', online: data.online || false, lastSeen: data.lastSeen || null };
    meNameLeft.textContent = profileCache[currentUser].name || currentUser;
    meBioLeft.textContent = profileCache[currentUser].bio || '';
    meAvatarLeft.src = profileCache[currentUser].avatar || 'https://via.placeholder.com/48';
    meAvatarLeft.dataset.user = currentUser;
    try{ loginModal.remove(); }catch(e){ loginModal.style.display='none'; }
    centerMain.classList.add('no-active');
    inputText.value = '';
    btnSend.disabled = true;
    inputText.disabled = true;
    try{ btnLogin.style.display = 'none'; }catch(e){}
    btnLogout.style.display = 'inline-flex';
    await setOnlineState(true);
    watchFriends();
    watchRequests();
  }catch(e){ console.error('restore session err', e); loginModal.style.display='flex'; }
}

/* Logout */
btnLogout.addEventListener('click', async ()=>{
  if(!currentUser) { btnLogin.style.display = 'inline-flex'; localStorage.removeItem('project_user'); location.reload(); return; }
  try{
    await setOnlineState(false);
  }catch(e){}
  localStorage.removeItem('project_user');
  currentUser = null;
  profileCache = {};
  activePeer = null;
  try{ btnLogout.style.display = 'none'; }catch(e){}
  try{ btnLogin.style.display = 'inline-flex'; }catch(e){}
  try{ loginModal.style.display = 'none'; }catch(e){}
});

/* keyboard quick submit */
loginUsername.addEventListener('keydown', e=> { if(e.key==='Enter') loginOk.click(); });
loginPassword.addEventListener('keydown', e=> { if(e.key==='Enter') loginOk.click(); });

/* UI toggles */
btnOpenFriends.addEventListener('click', ()=> {
  const opened = layoutRoot.classList.toggle('friends-open');
  document.getElementById('leftPanel').setAttribute('aria-hidden', opened ? 'false' : 'true');
  btnOpenFriends.classList.add('click-pop');
  setTimeout(()=> btnOpenFriends.classList.remove('click-pop'), 140);
});
closeFriends.addEventListener('click', ()=> { layoutRoot.classList.remove('friends-open'); document.getElementById('leftPanel').setAttribute('aria-hidden','true'); });

// header 'Entrar' opens login modal
try{ btnLogin.addEventListener('click', ()=> { loginModal.style.display = 'flex'; try{ loginUsername.focus(); }catch(e){} }); }catch(e){}

// left-panel edit icon opens profile modal (EDIT PROFILE) — this is the requested behavior
btnEditInlineIcon.addEventListener('click', ()=> {
  if(!currentUser){ toast('Faça login primeiro'); return; }
  profileModal.style.display = 'flex';
  profileAvatar.src = profileCache[currentUser]?.avatar || meAvatarLeft.src || 'https://via.placeholder.com/84';
  profileName.value = profileCache[currentUser]?.name || '';
  profileBio.value = profileCache[currentUser]?.bio || '';
});

// header theme button opens theme modal
btnTheme.addEventListener('click', ()=> {
  themeModal.style.display = 'flex';
});

// close profile
btnCloseProfile.addEventListener('click', ()=> profileModal.style.display='none');

/* Add friend flow */
btnAddFriend.addEventListener('click', async () => {
  if (!currentUser) return toast('Faça login primeiro');
  const raw = prompt('Digite o username do amigo:');
  if (!raw) return;
  const target = normalize(raw);
  if (target === currentUser) return toast('Você não pode se adicionar.');
  try{
    const snap = await db.doc('users/' + target).get();
    if (!snap.exists) return toast('Usuário não encontrado.');
    await db.collection('friendRequests').add({
      from: currentUser,
      to: target,
      status: 'pending',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    toast('Pedido enviado!');
  }catch(e){ console.error('add friend err', e); toast('Erro ao enviar pedido'); }
});

/* Requests watcher */
let currentRequests = {};
function watchRequests(){
  if(!currentUser) return;
  db.collection('friendRequests').where('to','==',currentUser).where('status','==','pending')
    .onSnapshot(snap=>{
      currentRequests = {};
      requestsList.innerHTML = '';
      if(snap.empty){
        requestsCount.style.display = 'none';
        return;
      }
      requestsCount.style.display = 'inline-block';
      requestsCount.textContent = String(snap.size);
      snap.docs.forEach(doc=>{
        const data = doc.data();
        currentRequests[doc.id] = { id: doc.id, ref: doc.ref, data };
        const row = document.createElement('div'); row.className = 'req-row';
        const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
        const avatar = document.createElement('img'); avatar.src = data.from && profileCache[data.from]?.avatar ? profileCache[data.from].avatar : 'https://via.placeholder.com/44'; avatar.style.width='36px'; avatar.style.height='36px'; avatar.style.borderRadius='8px';
        const name = document.createElement('div'); name.textContent = data.from || 'unknown';
        left.appendChild(avatar); left.appendChild(name);
        const actions = document.createElement('div'); actions.className = 'req-actions';
        const acceptBtn = document.createElement('button'); acceptBtn.className='btn btn-send'; acceptBtn.type='button'; acceptBtn.textContent='Aceitar';
        const declineBtn = document.createElement('button'); declineBtn.className='btn btn-plain'; declineBtn.type='button'; declineBtn.textContent='Recusar';
        actions.appendChild(acceptBtn); actions.appendChild(declineBtn);
        row.appendChild(left); row.appendChild(actions);
        requestsList.appendChild(row);

        acceptBtn.addEventListener('click', async ()=>{
          try{
            await db.doc('users/'+currentUser).set({ friends: firebase.firestore.FieldValue.arrayUnion(data.from) }, { merge: true });
            await db.doc('users/'+data.from).set({ friends: firebase.firestore.FieldValue.arrayUnion(currentUser) }, { merge: true });
            await doc.ref.update({ status: 'accepted', respondedAt: firebase.firestore.FieldValue.serverTimestamp() });
            toast('Amizade aceita!');
            row.remove();
            requestsCount.textContent = String(Math.max(0, Number(requestsCount.textContent)-1));
            if(requestsCount.textContent === '0') requestsCount.style.display='none';
            watchFriends();
            try{ playSendSound(); }catch(e){}
          }catch(e){ console.error('accept err', e); toast('Erro ao aceitar'); }
        });

        declineBtn.addEventListener('click', async ()=>{
          try{
            await doc.ref.update({ status: 'declined', respondedAt: firebase.firestore.FieldValue.serverTimestamp() });
            row.remove();
            requestsCount.textContent = String(Math.max(0, Number(requestsCount.textContent)-1));
            if(requestsCount.textContent === '0') requestsCount.style.display='none';
            toast('Pedido recusado');
          }catch(e){ console.error('decline err', e); toast('Erro ao recusar'); }
        });
      });
    }, err=> { console.error('watchRequests err', err); });
}

btnRequests.addEventListener('click', ()=>{
  if(!currentUser){ toast('Faça login para ver pedidos'); return; }
  requestsModal.style.display = 'flex';
});
requestsModal.addEventListener('click', (e)=> { if(e.target === requestsModal) requestsModal.style.display='none'; });

/* avatar upload */
btnChangeAvatar.addEventListener('click', ()=> profileFile.click());
profileFile.addEventListener('change', async ()=>{
  const f = profileFile.files && profileFile.files[0];
  if(!f || !currentUser) return;
  try{
    const local = URL.createObjectURL(f);
    profileAvatar.src = local;

    const path = `avatars/${currentUser}-${Date.now()}`;
    const ref = storage.ref().child(path);
    const snapshot = await ref.put(f, { contentType: f.type || 'image/jpeg' });
    const url = await snapshot.ref.getDownloadURL();

    await db.doc('users/'+currentUser).set({ avatar: url }, { merge:true });

    profileCache[currentUser] = profileCache[currentUser] || {};
    profileCache[currentUser].avatar = url;
    meAvatarLeft.src = url;
    meAvatarLeft.dataset.user = currentUser;
    profileAvatar.src = url;
    updateAllAvatars(currentUser, url);

    URL.revokeObjectURL(local);
    toast('Avatar salvo (Firebase Storage)');
  }catch(e){ console.error('avatar upload err', e); toast('Erro ao enviar avatar: '+ (e && e.message ? e.message : JSON.stringify(e))); }
});

/* save profile (name + bio) */
btnSaveProfile.addEventListener('click', async ()=>{
  if(!currentUser) return toast('Faça login');
  const name = (profileName.value||'').trim();
  const bio = (profileBio.value||'').trim().slice(0,200);
  try{
    await db.doc('users/'+currentUser).set({ name, bio }, { merge:true });
    profileCache[currentUser] = profileCache[currentUser] || {};
    profileCache[currentUser].name = name;
    profileCache[currentUser].bio = bio;
    meNameLeft.textContent = name || currentUser;
    meBioLeft.textContent = bio || '';
    profileModal.style.display = 'none';
    toast('Perfil atualizado');
  }catch(e){ console.error('save profile err', e); toast('Erro ao salvar perfil'); }
});

/* ========== FRIENDS WATCHER robust + real-time online/lastSeen fix ========== */
function removeFriendSubscription(username){
  const key = normalize(username);
  try{
    if(friendUnsubs[key] && typeof friendUnsubs[key] === 'function'){
      try{ friendUnsubs[key](); }catch(e){}
      delete friendUnsubs[key];
    }
    const node = friendsList.querySelector(`[data-user="${key}"]`);
    if(node) node.remove();
  }catch(e){ console.warn('removeFriendSubscription err', e); }
}

function watchFriends(){
  if(!currentUser) return;
  db.doc('users/' + currentUser).onSnapshot(async snap => {
    try{
      friendsList.innerHTML = '';
      const friends = snap.data()?.friends || [];
      const desired = new Set((friends||[]).map(f=>normalize(f)));
      Object.keys(friendUnsubs).forEach(existing => {
        if(!desired.has(existing)) removeFriendSubscription(existing);
      });
      for(const friend of friends){
        const key = normalize(friend);
        if(friendUnsubs[key]) continue;
        try{
          friendUnsubs[key] = db.doc('users/' + key)
            .onSnapshot(fsnap => {
              if(!fsnap.exists){ removeFriendSubscription(key); return; }
              const data = fsnap.data() || {};
              profileCache[key] = profileCache[key] || {};
              profileCache[key].name = data.name || profileCache[key].name || key;
              profileCache[key].avatar = data.avatar || profileCache[key].avatar || '';
              profileCache[key].bio = data.bio || profileCache[key].bio || '';
              profileCache[key].online = !!data.online;
              profileCache[key].lastSeen = data.lastSeen || null;
              const existing = friendsList.querySelector(`[data-user="${key}"]`);
              const node = createFriendNode(key, profileCache[key]);
              if(existing) friendsList.replaceChild(node, existing); else friendsList.appendChild(node);
            }, err => {
              console.error('friend doc watch err for', key, err);
              if(friendUnsubs[key]){ try{ friendUnsubs[key](); }catch(e){} delete friendUnsubs[key]; }
            });
        }catch(e){ console.error('subscribe friend err', key, e); }
      }
      if((friends||[]).length === 0) friendsList.innerHTML = '<div style="color:var(--muted);padding:8px">Nenhum amigo</div>';
    }catch(e){ console.error('watchFriends outer err', e); }
  });
}

function createFriendNode(username, data){
  const key = normalize(username);
  const div = document.createElement('div');
  div.className='friend';
  div.dataset.user = key;
  div.setAttribute('role','button');
  div.style.minWidth = '0';
  const img = document.createElement('img');
  img.src = data?.avatar || 'https://via.placeholder.com/44';
  img.alt = username;
  img.dataset.user = key;
  const info = document.createElement('div'); info.className='meta'; info.style.minWidth='0';
  const name = document.createElement('div'); name.className='name'; name.textContent = data?.name || username;
  const smallWrap = document.createElement('div'); smallWrap.style.display='flex'; smallWrap.style.alignItems='center'; smallWrap.style.gap='6px';
  const small = document.createElement('div'); small.className='small'; small.textContent = data?.online ? 'online' : 'offline';
  const dot = document.createElement('span'); dot.className = 'status-dot ' + (data?.online ? 'status-online' : 'status-offline');
  smallWrap.appendChild(small); smallWrap.appendChild(dot);
  info.appendChild(name); info.appendChild(smallWrap);
  div.appendChild(img); div.appendChild(info);
  div.addEventListener('click', ()=> { try{ openChat(username); }catch(e){ console.warn(e); } layoutRoot.classList.remove('friends-open'); document.getElementById('leftPanel').setAttribute('aria-hidden','true'); });
  return div;
}

/* ========== CHAT open/render/send/attach (reply + delete) ========== */
async function getProfile(u){
  const id = normalize(u);
  const snap = await db.doc('users/'+id).get();
  const data = snap.exists ? snap.data() : { name:id, avatar:'' };
  profileCache[id] = profileCache[id] || {};
  profileCache[id].name = data.name || id;
  profileCache[id].avatar = data.avatar || '';
  profileCache[id].bio = data.bio || '';
  profileCache[id].online = !!data.online;
  profileCache[id].lastSeen = data.lastSeen || null;
  return profileCache[id];
}

function updateAllAvatars(user, url){
  const key = normalize(user);
  const nodes = document.querySelectorAll(`[data-user="${key}"]`);
  nodes.forEach(n => {
    if(n.tagName && n.tagName.toLowerCase()==='img') n.src = url;
    else { const i = n.querySelector && n.querySelector('img'); if(i) i.src = url; }
  });
}

async function openChat(peerRaw){
  if(!currentUser) return toast('Faça login');
  const peer = normalize(peerRaw);
  if(unsubChat){ try{ unsubChat(); }catch(e){} unsubChat=null; }
  if(unsubPeer){ try{ unsubPeer(); }catch(e){} unsubPeer=null; }

  const pSnap = await db.doc('users/'+peer).get();
  const pData = pSnap.exists ? pSnap.data() : { name:peer, avatar:'' };
  profileCache[peer] = profileCache[peer] || {};
  profileCache[peer].name = pData.name || peer;
  profileCache[peer].avatar = pData.avatar || '';
  profileCache[peer].online = !!pData.online;
  profileCache[peer].lastSeen = pData.lastSeen || null;

  activePeer = peer;

  centerMain.classList.remove('no-active');
  emptyPlaceholder.style.display = 'none';
  peerName.textContent = profileCache[peer].name || peer;
  peerAvatarTop.src = profileCache[peer].avatar || 'https://via.placeholder.com/48';
  peerAvatarTop.dataset.user = peer;
  peerAvatarTop.style.display = 'inline-block';
  peerDotInline.style.display = 'inline-block';
  peerDotInline.className = 'status-dot ' + (profileCache[peer].online ? 'status-online' : 'status-offline');
  peerSub.textContent = profileCache[peer].online ? 'online' : (profileCache[peer].lastSeen ? ('visto: '+ new Date(profileCache[peer].lastSeen.seconds*1000).toLocaleString()) : '');

  unsubPeer = db.doc('users/' + peer).onSnapshot(snap=>{
    if(!snap.exists) return;
    const d = snap.data() || {};
    profileCache[peer] = profileCache[peer] || {};
    profileCache[peer].name = d.name || profileCache[peer].name || peer;
    profileCache[peer].avatar = d.avatar || profileCache[peer].avatar || '';
    profileCache[peer].online = !!d.online;
    profileCache[peer].lastSeen = d.lastSeen || profileCache[peer].lastSeen || null;

    peerName.textContent = profileCache[peer].name;
    peerAvatarTop.src = profileCache[peer].avatar || 'https://via.placeholder.com/48';
    if(profileCache[peer].online){
      peerSub.textContent = 'online';
      peerDotInline.className = 'status-dot status-online';
    } else {
      peerDotInline.className = 'status-dot status-offline';
      peerSub.textContent = profileCache[peer].lastSeen ? ('visto: '+ new Date(profileCache[peer].lastSeen.seconds*1000).toLocaleString()) : '';
    }
    updateAllAvatars(peer, profileCache[peer].avatar || '');
  });

  const chatId = [currentUser, peer].sort().join('__');

  let firstSnap = true;
  unsubChat = db.collection('chats').doc(chatId).collection('messages').orderBy('ts')
    .onSnapshot(async snap=>{
      messagesEl.innerHTML = '';
      for(const d of snap.docs){
        const m = d.data();
        const id = d.id;
        const author = normalize(m.from);
        if(author && !profileCache[author]) await getProfile(author);
        const el = await renderMessage(m, id);
        messagesEl.appendChild(el);
      }

      snap.docChanges().forEach(ch => {
        if(ch.type === 'added'){
          const m = ch.doc.data();
          const from = normalize(m.from);
          if(!firstSnap && from !== currentUser) try{ playReceiveSound(); }catch(e){}
        }
      });
      firstSnap = false;
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

  inputText.disabled = false;
  inputText.focus && inputText.focus();
  updateComposer();
  setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 120);
}

/* renderMessage */
async function renderMessage(m, docId){
  const from = normalize(m.from);
  const isMe = (from === currentUser);
  const row = document.createElement('div'); row.className = 'msg-row';
  row.style.justifyContent = isMe ? 'flex-end' : 'flex-start';
  row.dataset.msgid = docId;

  const avatar = document.createElement('img'); avatar.className='msg-avatar'; avatar.dataset.user = from;
  avatar.src = (m.avatar && m.avatar.trim()) ? m.avatar : (profileCache[from] && profileCache[from].avatar) || 'https://via.placeholder.com/44';
  avatar.addEventListener('click', (ev)=>{ ev.stopPropagation(); openAnyUserProfile(from); });

  const bubble = document.createElement('div'); bubble.className = 'msg ' + (isMe ? 'me' : 'their');
  bubble.style.maxWidth = 'calc(100% - 72px)';
  bubble.dataset.msgid = docId;

  const meta = document.createElement('div'); meta.className = 'meta';
  meta.textContent = (profileCache[from] && profileCache[from].name) ? profileCache[from].name : from;
  bubble.appendChild(meta);

  if(m.deleted){
    const removed = document.createElement('div');
    removed.textContent = 'Mensagem apagada';
    removed.style.fontStyle = 'italic';
    removed.style.opacity = '0.9';
    bubble.appendChild(removed);
  } else {
    if(m.replyToId){
      const replyBox = document.createElement('div');
      replyBox.style.borderLeft = '3px solid rgba(255,255,255,0.06)';
      replyBox.style.paddingLeft = '8px';
      replyBox.style.marginBottom = '6px';
      replyBox.style.fontSize = '13px';
      replyBox.style.color = 'var(--muted)';
      replyBox.textContent = 'Carregando resposta...';
      bubble.appendChild(replyBox);

      (async ()=>{
        try{
          const chatId = [currentUser, activePeer].sort().join('__');
          const docRef = db.collection('chats').doc(chatId).collection('messages').doc(m.replyToId);
          const snap = await docRef.get();
          if(!snap.exists){ replyBox.textContent = 'Mensagem apagada'; return; }
          const real = snap.data() || {};
          if(real.deleted) replyBox.textContent = 'Mensagem apagada';
          else if(real.text && real.text.trim()){
            replyBox.textContent = real.from + ': ' + (real.text.length>80 ? real.text.slice(0,80)+'…' : real.text);
          } else if(real.imageUrl){
            replyBox.textContent = real.from + ': [imagem]';
          } else {
            replyBox.textContent = real.from + ': (sem conteúdo)';
          }
        }catch(e){ console.debug('reply preview fetch err', e); }
      })();
    }

    if(m.text && m.text.trim()){
      const p = document.createElement('div'); p.textContent = m.text; bubble.appendChild(p);
    }
    if(m.imageUrl){
      const img = document.createElement('img'); img.className = 'msg-image'; img.src = m.imageUrl; img.alt='imagem';
      img.addEventListener('click', ()=> window.open(m.imageUrl,'_blank'));
      bubble.appendChild(img);
    }
  }

  bubble.style.cursor = 'pointer';
  bubble.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    showMessageActions(docId, m, bubble);
  });

  if(isMe){
    row.appendChild(bubble);
    row.appendChild(avatar);
  } else {
    row.appendChild(avatar);
    row.appendChild(bubble);
  }
  return row;
}

/* message action popup */
function showMessageActions(docId, m, anchorEl){
  msgActionPopup.style.display = 'none';
  msgActionPopup.innerHTML = '';
  const btnReply = document.createElement('button'); btnReply.type='button'; btnReply.textContent='Responder';
  btnReply.addEventListener('click', ()=>{ setReplyTo(docId, m); hideMsgActionPopup(); });
  const actionsContainer = document.createElement('div'); actionsContainer.style.display='flex'; actionsContainer.style.gap='6px';
  actionsContainer.appendChild(btnReply);
  if(m.from === currentUser && !m.deleted){
    const btnDelete = document.createElement('button'); btnDelete.type='button'; btnDelete.textContent='Apagar para todos'; btnDelete.style.color='#ff7b7b';
    btnDelete.addEventListener('click', async ()=>{
      const ok = confirm('Apagar esta mensagem para todos? Esta ação não pode ser desfeita.');
      if(!ok) return;
      try{ await deleteMessageForEveryone(docId); hideMsgActionPopup(); }catch(e){ console.error(e); alert('Erro ao apagar'); }
    });
    actionsContainer.appendChild(btnDelete);
  }
  const btnClose = document.createElement('button'); btnClose.type='button'; btnClose.textContent='Fechar';
  btnClose.addEventListener('click', hideMsgActionPopup);
  actionsContainer.appendChild(btnClose);
  msgActionPopup.appendChild(actionsContainer);
  msgActionPopup.style.display = 'flex';
  const rect = anchorEl.getBoundingClientRect();
  setTimeout(()=> {
    const popupRect = msgActionPopup.getBoundingClientRect();
    let left = rect.left + (rect.width/2) - (popupRect.width/2);
    let top = rect.top - popupRect.height - 10;
    if(top < 8) top = rect.bottom + 8;
    if(left < 8) left = 8;
    msgActionPopup.style.left = left + 'px';
    msgActionPopup.style.top = top + 'px';
  }, 10);
}
function hideMsgActionPopup(){ msgActionPopup.style.display = 'none'; }

/* delete message */
async function deleteMessageForEveryone(docId){
  if(!currentUser || !activePeer) throw new Error('Sem chat ativo');
  const chatId = [currentUser, activePeer].sort().join('__');
  const ref = db.collection('chats').doc(chatId).collection('messages').doc(docId);
  await ref.update({
    deleted: true,
    deletedBy: currentUser,
    deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
    text: '',
    imageUrl: ''
  });
}

/* reply management */
let pendingReply = null;
function setReplyTo(docId, m){
  pendingReply = { id: docId, from: m.from, text: m.text || '', imageUrl: m.imageUrl || '' };
  renderReplyPreview();
}
function clearReply(){ pendingReply = null; replyPreview.style.display = 'none'; replyPreview.innerHTML = ''; }
function renderReplyPreview(){
  if(!pendingReply) return clearReply();
  replyPreview.innerHTML = '';
  replyPreview.style.display = 'flex';
  const who = document.createElement('div'); who.className='small'; who.textContent = pendingReply.from;
  const txt = document.createElement('div'); txt.className='text'; txt.textContent = pendingReply.text ? (pendingReply.text.length>120 ? pendingReply.text.slice(0,120)+'…' : pendingReply.text) : (pendingReply.imageUrl ? '[imagem]' : '(sem conteúdo)');
  const cancel = document.createElement('button'); cancel.className='btn btn-plain'; cancel.type='button'; cancel.textContent='Cancelar';
  cancel.style.marginLeft = '8px'; cancel.addEventListener('click', ()=> clearReply());
  replyPreview.appendChild(who); replyPreview.appendChild(txt); replyPreview.appendChild(cancel);
}

/* send (text + image) */
btnSend.addEventListener('click', async ()=>{
  if(!currentUser || !activePeer) return toast('Selecione um chat e faça login');
  const text = (inputText.value||'').trim();
  if(!text && !pendingFileLocal) return;
  const chatId = [currentUser, activePeer].sort().join('__');
  const avatarForMsg = profileCache[currentUser]?.avatar || '';
  try{
    const msg = { from: currentUser, to: activePeer, text: text || '', avatar: avatarForMsg, imageUrl: '', ts: firebase.firestore.FieldValue.serverTimestamp() };
    if(pendingReply){ msg.replyToId = pendingReply.id; msg.replySnapshot = { id: pendingReply.id, from: pendingReply.from, text: pendingReply.text || '', imageUrl: pendingReply.imageUrl || '', deleted:false }; }
    if(pendingFileLocal){
      const ext = (pendingFileLocal.name.split('.').pop() || 'jpg').toLowerCase();
      const path = `chats/${chatId}/${Date.now()}.${ext}`;
      let imageUrl = null;
      try{
        const { error: uploadError } = await supabaseClient.storage.from('project').upload(path, pendingFileLocal, { cacheControl:'3600', upsert:false });
        if(uploadError) throw uploadError;
        const { data } = supabaseClient.storage.from('project').getPublicUrl(path);
        imageUrl = data?.publicUrl;
      }catch(supErr){
        console.warn('Supabase failed -> Firebase fallback', supErr);
        try{
          const fbPath = `chats/${chatId}/${Date.now()}`;
          const ref = storage.ref().child(fbPath);
          const snap = await ref.put(pendingFileLocal, { contentType: pendingFileLocal.type || 'image/jpeg' });
          imageUrl = await snap.ref.getDownloadURL();
        }catch(fbErr){ console.error('Firebase fallback failed', fbErr); throw new Error('Erro ao enviar imagem'); }
      }
      if(!imageUrl) throw new Error('Não foi possível obter URL da imagem');
      msg.imageUrl = imageUrl;
      composerPreviewImg.innerHTML=''; composerPreviewImg.style.display='none'; pendingFileLocal = null;
    }
    await db.collection('chats').doc(chatId).collection('messages').add(msg);
    try{ playSendSound(); }catch(e){}
    inputText.value=''; clearReply(); updateComposer();
  }catch(e){ console.error('send text err', e); toast('Erro ao enviar mensagem: '+ (e && e.message? e.message : JSON.stringify(e))); }
});
inputText.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btnSend.click(); }});
function updateComposer(){ btnSend.disabled = !(currentUser && activePeer && ((inputText.value && inputText.value.trim().length>0) || pendingFileLocal)); }

/* attach image preview */
btnAttach.addEventListener('click', ()=> { if(!currentUser) return toast('Faça login'); if(!activePeer) return toast('Abra um chat'); inputFile.click(); });
inputFile.addEventListener('change', ()=> {
  const f = inputFile.files && inputFile.files[0];
  if(!f) return;
  pendingFileLocal = f;
  composerPreviewImg.innerHTML=''; composerPreviewImg.style.display='block';
  const thumb = document.createElement('img'); thumb.src = URL.createObjectURL(f); thumb.style.width='84px'; thumb.style.height='84px'; thumb.style.objectFit='cover'; thumb.style.borderRadius='8px';
  const cancel = document.createElement('button'); cancel.className='btn btn-plain'; cancel.type='button'; cancel.textContent='Remover';
  cancel.addEventListener('click', ()=> { try{ URL.revokeObjectURL(thumb.src); }catch(e){} composerPreviewImg.innerHTML=''; composerPreviewImg.style.display='none'; pendingFileLocal = null; updateComposer(); }, { once:true });
  composerPreviewImg.appendChild(thumb); composerPreviewImg.appendChild(cancel);
  updateComposer();
});

/* hide popup when clicking outside */
document.addEventListener('click', (e)=> { if(msgActionPopup.style.display === 'none') return; if(!msgActionPopup.contains(e.target)) hideMsgActionPopup(); });
window.addEventListener('resize', hideMsgActionPopup);

/* start watchers if logged */
function startRequestsIfNeeded(){ if(currentUser) watchRequests(); }

/* ========== Peer profile modal (open by header avatar/name or any message avatar) ========== */
async function openPeerProfileModal(){
  if(!activePeer){ toast('Nenhum chat selecionado'); return; }
  try{
    const snap = await db.doc('users/'+activePeer).get();
    const profile = snap.exists ? snap.data() : (profileCache[activePeer] || { name: activePeer, avatar:'', bio:'' });
    profileCache[activePeer] = profileCache[activePeer] || {};
    profileCache[activePeer].name = profile.name || activePeer;
    profileCache[activePeer].avatar = profile.avatar || profileCache[activePeer].avatar || '';
    profileCache[activePeer].bio = profile.bio || profileCache[activePeer].bio || '';
    profileCache[activePeer].online = !!profile.online;
    profileCache[activePeer].lastSeen = profile.lastSeen || null;

    peerProfileAvatar.src = profileCache[activePeer].avatar || 'https://via.placeholder.com/120';
    peerProfileName.textContent = profileCache[activePeer].name || activePeer;
    if(profileCache[activePeer].online){
      peerProfileMeta.textContent = 'online';
    } else {
      peerProfileMeta.textContent = profileCache[activePeer].lastSeen ? ('visto: ' + new Date(profileCache[activePeer].lastSeen.seconds*1000).toLocaleString()) : 'offline';
    }
    peerProfileBio.textContent = profileCache[activePeer].bio || 'Sem bio';
    peerProfileAdd.style.display = (currentUser && currentUser !== activePeer) ? 'inline-block' : 'none';
    peerProfileModal.style.display = 'flex';
    peerProfileModal.setAttribute('aria-hidden','false');
  }catch(e){ console.error('openPeerProfileModal err', e); toast('Erro ao abrir perfil'); }
}
function closePeerProfileModal(){ peerProfileModal.style.display = 'none'; peerProfileModal.setAttribute('aria-hidden','true'); }
peerProfileClose.addEventListener('click', closePeerProfileModal);
peerProfileMessage.addEventListener('click', ()=> { closePeerProfileModal(); if(activePeer) openChat(activePeer); });
peerProfileModal.addEventListener('click', (e)=> { if(e.target === peerProfileModal) closePeerProfileModal(); });

/* open profile of any username (used when clicking msg-avatar) */
async function openAnyUserProfile(username){
  try{
    const user = normalize(username);
    const snap = await db.doc('users/'+user).get();
    const profile = snap.exists ? snap.data() : (profileCache[user] || { name:user, avatar:'', bio:'' });
    activePeer = user;
    profileCache[user] = profileCache[user] || {};
    profileCache[user].name = profile.name || user;
    profileCache[user].avatar = profile.avatar || profileCache[user].avatar || '';
    profileCache[user].bio = profile.bio || profileCache[user].bio || '';
    profileCache[user].online = !!profile.online;
    profileCache[user].lastSeen = profile.lastSeen || null;

    peerProfileAvatar.src = profileCache[user].avatar || 'https://via.placeholder.com/120';
    peerProfileName.textContent = profileCache[user].name || user;
    if(profileCache[user].online){
      peerProfileMeta.textContent = 'online';
    } else {
      peerProfileMeta.textContent = profileCache[user].lastSeen ? ('visto: ' + new Date(profileCache[user].lastSeen.seconds*1000).toLocaleString()) : 'offline';
    }
    peerProfileBio.textContent = profileCache[user].bio || 'Sem bio';
    peerProfileAdd.style.display = (currentUser && currentUser !== user) ? 'inline-block' : 'none';
    peerProfileModal.style.display = 'flex';
    peerProfileModal.setAttribute('aria-hidden','false');
  }catch(e){ console.error('openAnyUserProfile err', e); toast('Erro'); }
}

/* add friend from peer profile */
peerProfileAdd.addEventListener('click', async ()=>{
  if(!currentUser || !activePeer) return toast('Faça login');
  try{
    await db.collection('friendRequests').add({ from: currentUser, to: activePeer, status: 'pending', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    toast('Pedido enviado');
    peerProfileAdd.style.display = 'none';
  }catch(e){ console.error('peer add err', e); toast('Erro ao enviar pedido'); }
});

/* ensure clicks on message avatars also open profile (delegation) */
messagesEl.addEventListener('click', (e)=>{
  const av = e.target.closest && e.target.closest('.msg-avatar');
  if(av && av.dataset && av.dataset.user){
    openAnyUserProfile(av.dataset.user);
  }
});

/* ========== Theme picker: change many variables for immersive look ========== */
const THEMES = [
  { id:'mono', name:'Minimal', css: { '--accent':'#ffffff','--card':'#0f1012','--bg':'#0b0b0b','--muted':'#9b9b9b','--bubble-me-bg':'#0d0d0d','--bubble-their-bg':'#ffffff','--btn-bg':'#ffffff','--btn-text':'#000000','--input-bg':'#080808','--input-text':'#ffffff','--header-gradient-top':'linear-gradient(180deg,#0f1012,#090909)'} },
  { id:'blue', name:'Atlântico', css: { '--accent':'#30a8ff','--card':'#071529','--bg':'#04101a','--muted':'#9fbcd6','--bubble-me-bg':'#052033','--bubble-their-bg':'#07243a','--btn-bg':'#30a8ff','--btn-text':'#04101a','--input-bg':'#031222','--input-text':'#cfefff','--header-gradient-top':'linear-gradient(180deg,#071529,#020a12)'} },
  { id:'violet', name:'Violeta', css: { '--accent':'#b77cff','--card':'#12061a','--bg':'#07020a','--muted':'#c9b8e8','--bubble-me-bg':'#1b0b25','--bubble-their-bg':'#17061a','--btn-bg':'#b77cff','--btn-text':'#200b2a','--input-bg':'#0a0510','--input-text':'#f3eaff','--header-gradient-top':'linear-gradient(180deg,#12061a,#050012)'} },
  { id:'green', name:'Verde', css: { '--accent':'#1fb86a','--card':'#062012','--bg':'#04120a','--muted':'#9ddbb5','--bubble-me-bg':'#042212','--bubble-their-bg':'#062617','--btn-bg':'#1fb86a','--btn-text':'#052512','--input-bg':'#02180d','--input-text':'#dff8ea','--header-gradient-top':'linear-gradient(180deg,#062012,#011108)'} },
  { id:'red', name:'Rubi', css: { '--accent':'#ff6b6b','--card':'#18080a','--bg':'#080404','--muted':'#f2c6c6','--bubble-me-bg':'#2a0a0b','--bubble-their-bg':'#1d0708','--btn-bg':'#ff6b6b','--btn-text':'#2b0707','--input-bg':'#0b0505','--input-text':'#ffefef','--header-gradient-top':'linear-gradient(180deg,#18080a,#050202)'} },
  { id:'gold', name:'Elegante', css: { '--accent':'#ffd166','--card':'#21150d','--bg':'#0b0703','--muted':'#ead7b7','--bubble-me-bg':'#2d1c0f','--bubble-their-bg':'#24130b','--btn-bg':'#ffd166','--btn-text':'#231609','--input-bg':'#120b07','--input-text':'#fff7ea','--header-gradient-top':'linear-gradient(180deg,#21150d,#0b0502)'} }
];

function applyThemeObj(themeObj){
  if(!themeObj || !themeObj.css) return;
  Object.entries(themeObj.css).forEach(([k,v]) => document.documentElement.style.setProperty(k, v));
  try{ localStorage.setItem('projectTheme', themeObj.id); }catch(e){}
}
function buildThemeGrid(){
  themeGrid.innerHTML = '';
  THEMES.forEach(t => {
    const sw = document.createElement('div'); sw.className='theme-swatch'; sw.title = t.name;
    sw.style.background = `linear-gradient(135deg, ${t.css['--accent']} 0%, ${t.css['--card']} 100%)`;
    sw.addEventListener('click', ()=> { applyThemeObj(t); themeModal.style.display='none'; });
    themeGrid.appendChild(sw);
  });
}
themeClose.addEventListener('click', ()=> themeModal.style.display='none');
themeModal.addEventListener('click', (e)=> { if(e.target === themeModal) themeModal.style.display='none'; });
(function(){ buildThemeGrid(); try{ const saved = localStorage.getItem('projectTheme') || 'mono'; const t = THEMES.find(x=>x.id===saved) || THEMES[0]; applyThemeObj(t); }catch(e){} })();

/* initial UI state */
centerMain.classList.add('no-active');
emptyPlaceholder.style.display = 'flex';
messagesEl.innerHTML = '';
inputText.disabled = true;
btnSend.disabled = true;
setInterval(()=>{ try{ updateComposer(); }catch(e){} },300);
inputText.addEventListener('focus', ()=> setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 200));

/* debug helpers */
window.openChat = openChat;
window.getProfile = getProfile;
window.db = db;
window.supabaseClient = supabaseClient;
</script>
</body>

</html>
